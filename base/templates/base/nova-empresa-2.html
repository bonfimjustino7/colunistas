<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    {% include "base/includes/css_padrao.html" %}

    {% if messages %}
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    {% endif %}

    {% block css %}{% endblock %}

    <title>Empresa Responsável pela Inscrição</title>
</head>
<body>
<table width="60%" align="center">
<tr>
<td>    
    <div class="container-fluid">
    <div class="row my-2">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body formulario-empresa">

                    <form action="/nova-empresa/" method="post">
                        {% csrf_token %}

                        <div class="row my-1">
                          <img src="/static/base/img/logo.png" class="logo" alt="Prêmio Colunistas">
                        </div>  

                        <div class="row my-1">
                            <div class="col-12 text-center font-weight-bold">
                                <h1 class="title">EMPRESA RESPONSÁVEL PELA INSCRIÇÃO</h1>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label>Regional em que irá concorrer:</label>
                                    {{formulario_cadastro.regional}}                                
                                <span class="text-muted" style="font-size: 12px;">Consulte o regulamento para saber em qual delas a sua região se enquadra.</span>
                                    {{formulario_cadastro.regional.errors}}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="id_Empresa">Nome da Empresa:</label>
                                 {{formulario_cadastro.nome}}
                                <span class="text-muted" style="font-size: 12px;">Use o nome de fantasia simplificado da empresa, sem "Ltda", "Propaganda", "Comunicação", "Criação", "Promoções", etc.</span>
                                <input type="hidden" id = "id_pk" value = {{ id_empresa }}>  
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_Codarea">Área de Atuação:
                                  {{formulario_cadastro.area}}
                                </label>
                                <span class="text-muted" style="font-size: 12px;"><br/>Escolha a que mais se aproxime da sua principal área de atuação.</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-2">
                                <label for="id_Cep">CEP:</label>
                                    {{formulario_cadastro.cep}}
                                <span class="text-muted" style="font-size: 12px;">Digite no formato 00000-000</span>
                            </div>
                            <div class="col-md-4">
                                <label for="id_Cidade">Cidade:</label>
                                    {{formulario_cadastro.cidade}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                                    {{formulario_cadastro.cidade.errors}}
                            </div>
                            <div class="col-md-1" style="width: 50px;">
                                <label for="id_Estado">Estado:</label>
                                    {{formulario_cadastro.uf}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-7">
                                <label for="id_Endereco">Endereço:</label>
                                    {{formulario_cadastro.endereco}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                                
                            </div>
                            <div class="col-md-3">
                                <label for="id_Bairro">Bairro:</label>
                                    {{formulario_cadastro.bairro}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                        </div>
                        

                        <div class="row">
                            <div class="col-md-1">
                                <label for="id_DDD">DDD:</label>
                                    {{formulario_cadastro.ddd}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                                
                            </div>
                            <div class="col-md-3">
                                <label for="id_Telefone1">Telefone:</label>
                                    {{formulario_cadastro.telefone}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                            
                            <div class="col-md-3">
                                <label for="id_Telefone2">Outro Telefone:</label>
                                    {{formulario_cadastro.celular}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="id_HomePage">Home-Page da Empresa:</label>
                                    {{formulario_cadastro.homepage}}
                                <span class="text-muted" style="font-size: 11px;">Digite o endereço do site da empresa. Não precisa digitar "http://"</span>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_Email">E-Mail da Empresa:</label>
                                    {{formulario_cadastro.email}}
                                <span class="text-muted" style="font-size: 11px;">Apenas se a empresa tiver um email central.</span>
                            </div>
                            
                        </div>

                        <hr class="my-4">

                        <div class="row my-3">
                            <div class="col-12 text-center font-weight-bold">VP OU DIRETOR RESPONSÁVEL PELAS INSCRIÇÕES</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="id_DirResp">Nome:</label>
                                    {{formulario_cadastro.VP_Nome}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                            <div class="col-md-6">
                                <label for="id_DirCargo">Cargo:</label>
                                    {{formulario_cadastro.VP_Cargo}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="id_DirEmail">E-Mail:</label>
                                    {{formulario_cadastro.VP_Email}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                            
                            <div class="col-md-1">
                                <label for="id_DirDDD">DDD:</label>
                                    {{formulario_cadastro.VP_DDD}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="id_DirTelefoneDireto">Celular (de preferência) ou Tel.Direto:</label>
                                    {{formulario_cadastro.VP_Telefone}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row my-3">
                            <div class="col-12 text-center font-weight-bold">OUTROS CONTATOS NA EMPRESA</div>
                            <div class="col-12 text-center">
                            (Profissionais  que também receberão as comunicações da Abracomp sobre a premiação.)</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="id_NomResp1">Nome:</label>
                                    {{formulario_cadastro.C1_Nome}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                            <div class="col-md-6">
                                <label for="id_Cargo1">Cargo:</label>
                                    {{formulario_cadastro.C1_Cargo}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="id_Email1">E-Mail:</label>
                                     {{formulario_cadastro.C1_Email}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>

                            <div class="col-md-1">
                                <label for="id_DDD1">DDD:</label>
                                    {{formulario_cadastro.C1_DDD}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>

                            <div class="col-md-4">
                                <label for="id_TelefoneDireto1">Celular (de preferência) ou Tel.Direto:</label>
                                    {{formulario_cadastro.C1_Telefone}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="id_NomeResp2">Nome:</label>
                                    {{formulario_cadastro.C2_Nome}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                            <div class="col-md-6">
                                <label for="id_Cargo2">Cargo:</label>
                                    {{formulario_cadastro.C2_Cargo}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                                
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="id_Email2">E-Mail:</label>
                                    {{formulario_cadastro.C2_Email}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                            
                            <div class="col-md-1">
                                <label for="id_DDD2">DDD:</label>
                                    {{formulario_cadastro.C2_DDD}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="id_TelefoneDireto2">Celular (de preferência) ou Tel.Direto:</label>
                                    {{formulario_cadastro.C2_Telefone}}
                                <span class="text-muted" style="font-size: 12px;"></span>
                            </div>
                            
                        </div>

                        <hr class="my-4">

                        <div id="formset_agencias">
                            <div class="row my-3">
                                <div class="col-12 text-center font-weight-bold header-agencia d-none">AGÊNCIAS CADASTRADAS PARA FICHAS TÉCNICAS</div>
                            </div>
                            {{formset_agencias.management_form}}
                        </div>

                        <div class="row">
                            <div class="col-md-12 text-center botoes-inciais">
                                <button type="button" onclick="enviar()" id="btn_submit" class="btn btn-primary">Gravar os Dados</button>
                                <a href="javascript:adiciona_agencia()" id="btn_agencias" class="btn btn-primary d-none" data-toggle="tooltip" data-placement="top" title="Você pode adicionar mais de uma agência, clicando aqui">Adicionar Agência</a>
                                <span class="botoes-adicionais d-none"><a href="/admin/inscricao/inscricao/add/" id="btn_inscricoes" class="btn btn-outline-primary">Cadastrar Inscrições</a></span>
                            </div>
                            <div class="col-md-12 text-center dados-fiscais d-none">
                                <a href="javascript:dados_fiscais()" id="btn_dados_fiscais" class="btn btn-outline-primary">Dados Fiscais</a>
                            </div>
                        </div>

                    </form>
                </div>
            </div>

        </div>
    </div>

        </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.33.1/sweetalert2.all.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.15/jquery.mask.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.15/jquery.mask.min.js"></script>

        
    <script>
        // Variáveis globais:
        var estados_agencias = '';
        dados = {};
            
        function carrega_dados_formulario() {
            if ($('#id_pk').val() > 0) {
                dados.pk = $('#id_pk').val()
            }
            dados.csrfmiddlewaretoken = $('input[name="csrfmiddlewaretoken"]').val()
            dados.regional = $('#id_regional').val()
            dados.nome = $('#id_nome').val()
            dados.area = $('#id_area').val()
            dados.cep = $('#id_cep').val()
            dados.endereco = $('#id_endereco').val()
            dados.bairro = $('#id_bairro').val()
            dados.cidade= $('#id_cidade').val()
            dados.uf = $('#id_uf').val()
            dados.ddd = $('#id_ddd').val()
            dados.telefone = $('#id_telefone').val()
            dados.celular = $('#id_celular').val()
            dados.homepage = $('#id_homepage').val()
            dados.email = $('#id_email').val()
            dados.VP_Nome = $('#id_VP_Nome').val()
            dados.VP_Cargo = $('#id_VP_Cargo').val()
            dados.VP_Email = $('#id_VP_Email').val()
            dados.VP_DDD = $('#id_VP_DDD').val()
            dados.VP_Telefone = $('#id_VP_Telefone').val()
            dados.C1_Nome = $('#id_C1_Nome').val()
            dados.C1_Cargo = $('#id_C1_Cargo').val()
            dados.C1_Email = $('#id_C1_Email').val()
            dados.C1_DDD = $('#id_C1_DDD').val()
            dados.C1_Telefone = $('#id_C1_Telefone').val()
            dados.C2_Nome = $('#id_C2_Nome').val()
            dados.C2_Cargo = $('#id_C2_Cargo').val()
            dados.C2_Email = $('#id_C2_Email').val()
            dados.C2_DDD = $('#id_C2_DDD').val()
            dados.C2_Telefone = $('#id_C2_Telefone').val()

            dados['form-TOTAL_FORMS'] = $('#id_form-TOTAL_FORMS').val()
            dados['form-INITIAL_FORMS'] = $('#id_form-INITIAL_FORMS').val()
            dados['form-MIN_NUM_FORMS'] = $('#id_form-MIN_NUM_FORMS').val()
            dados['form-MAX_NUM_FORMS'] = $('#id_form-MAX_NUM_FORMS').val()

            for (i = 0; i < parseInt(dados['form-TOTAL_FORMS']); i++) {
                dados[`form-${i}-nome`] = $(`#id_form-${i}-nome`).val();
                dados[`form-${i}-uf`] = $(`#id_form-${i}-uf`).val();
            }
        }

        function carrega_estados_agencias() {
            var url = '/estados-regional/?regional=' + $('#id_regional').val()
            var area = $('#id_area option:selected' ).text();
            //$('#formset_agencias input[type="text"]').val('');

            if (area.substr(0,26) == 'Empresa de Mkt.Promocional' || area.substr(0,17) == 'Empresa de Design' || area.substr(0,26) == 'Agência de Publicidade' || area == '')  {
                $('#btn_agencias').addClass('d-none');
                $('#formset_agencias').addClass('d-none');
            }else{
                if ($('#id_pk').val() > 0) {    
                    $('#btn_agencias').removeClass('d-none');
                    $('#formset_agencias').removeClass('d-none');
                }else{
                    $('#btn_agencias').addClass('d-none');
                    $('#formset_agencias').addClass('d-none');
                }
            }


            if (area.substr(0,9)  == 'Produtora' ) {
                url = '/estados-regional/?regional=-1'
            }

        

            $.get(url)
            .done(function(resposta) {
                estados_agencias = '';
                $.each(resposta.estados, function(i, estado) {
                    estados_agencias += `<option value="${estado}">${estado}</option>`
                });
                if ($('#id_form-TOTAL_FORMS').val() == 0) {
                    adiciona_agencia();
                    $('.header-agencia').removeClass('d-none');
                }else{
                    $( ".select-nome" ).each(function() {
                        //var option = "<option value='' selected disabled>Selecione...</option>";
                        $(this).empty().append(option).append(estados_agencias);
                    });
                }

            })
        }

        function enviar() {
            var url = '{% url 'nova-empresa' %}'
            carrega_dados_formulario()
            if ($('#id_pk').val() > 0) {
                dados.id = $('#id_pk').val()
            }

            $.post(url, dados)
            .done(resposta => {
                if (resposta.status == 200) { 
                    console.log(resposta.existe)
                    $('#id_pk').val(resposta.pk)
                    carrega_estados_agencias();
                    $('#btn_submit').prop('disabled', false);
                    $('#btn_submit').removeClass('disabled');
                    
                    // tem que ter um if aqui para só habilitar se tiver agência já preenchida
        
                    //$('.botoes-adicionais').removeClass('d-none');
                    Swal.fire({
                        type: 'success',
                        text: 'Empresa cadastrada com sucesso',
                    })
                    //$('.botoes-inciais').addClass('d-none');
                    if ( resposta.agencia_full == true ) {
                      $('.botoes-adicionais').removeClass('d-none');  
                    }

                } else {
                    Swal.fire({
                        type: 'error',
                        text: `Erro: ${resposta.texto}`,
                    })
                    console.log(resposta)
                }
            })
            .fail(resposta => {
                Swal.fire({
                    type: 'error',
                    text: `Erro: ${resposta.statusText}`,
                })
                console.log(resposta)
            })
        }

        function adiciona_agencia() {
            var n_forms = $('#id_form-TOTAL_FORMS').val()
            $('#formset_agencias').append(`
                <div class="row my-2">
                    <div class="col-md-2">
                        <label for="id_form-${n_forms}-nome">Nome:</label>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="form-${n_forms}-nome" id="id_form-${n_forms}-nome" />
                    </div>
                    <div class="col-md-2">
                        <label for="id_form-${n_forms}-uf">Estado:</label>
                    </div>
                    <div class="col-md-4">
                        <select name="uf" id="id_form-${n_forms}-uf" class="form-control select-uf">
                            <option value="" selected disabled>Selecione...</option>
                            ${estados_agencias}
                        </select>
                    </div>
                </div>
            `)
            $('#id_form-TOTAL_FORMS').val( parseInt($('#id_form-TOTAL_FORMS').val()) + 1 )
        }

        function exclui_agencia() {}

        function verificar_nome_empresa() {
            if ($('#id_nome').val()) {
                var url = `/consulta-empresa/${$('#id_nome').val()}/`
                $.get(url)
                .done(function(resposta) {
                    if (resposta.existe) {
                        $('#btn_submit').prop('disabled', false)
                        $('#btn_submit').removeClass('disabled')

                        Swal.fire({
                            type: 'error',
                            title: 'AVISO',
                            text: 'Empresa já cadastrada',
                        })
                    } else {
                        $('#btn_submit').prop('disabled', false)
                        $('#btn_submit').removeClass('disabled')
                    }
                })
                .fail(function() {
                    console.log('Erro ao acessar o servidor')
                });
            }
        }  

        function dados_fiscais() {
            Swal.fire({
                html: `{{formulario_fiscal.as_p}}`,
                showCancelButton: true,
                confirmButtonText: 'Gravar',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    dados = {
                        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val(),
                        cnpj: $('#id_cnpj').val(),
                        inscricao_estadual: $('#id_inscricao_estadual').val(),
                        inscricao_municipal: $('#id_inscricao_municipal').val(),
                    }

                    $.post('/cadastro-fiscal/', dados)
                    .done((resposta) => {
                        if (resposta.status == 200) {
                            Swal.fire({
                                type: 'success',
                                text: 'Dados cadastrados com sucesso.',
                            })
                        } else {
                            Swal.fire({
                                type: 'error',
                                text: resposta.texto,
                            })
                        }
                    })
                    .fail((resposta) => {
                        if (resposta) {
                            Swal.fire({
                                type: 'error',
                                text: `Erro: ${resposta.statusText}`,
                            })
                        } else {
                            Swal.fire({
                                type: 'error',
                                text: 'Erro ao conectar com o servidor.',
                            })
                        }
                    })
                },
                allowOutsideClick: () => !Swal.isLoading()
            })
        }

        $("#id_cep").mask("00000-000");

        function pesquisaCep() {
            var entrada = document.getElementById('id_cep').value.replace('-', '')
            $.get(`https://viacep.com.br/ws/${entrada}/json/`, function(endereco, status) {
                if (status == 'success') {
                    //console.log(endereco)
                    $('#id_endereco').val(endereco.logradouro)
                    $('#id_bairro').val(endereco.bairro)
                    $('#id_uf').val(endereco.uf)
                    $('#id_cidade').val(endereco.localidade)
                }
            });
        }

        $(document).ready(function(){
            $("body").tooltip({ selector: '[data-toggle=tooltip]' });
            $('input[type="text"], input[type="email"], input[type="url"], select').addClass('form-control');

            $('#id_regional').change(carrega_estados_agencias);
            $('#id_area').change(carrega_estados_agencias);
            $('#id_nome').blur(verificar_nome_empresa);
            $('#id_cep').blur(pesquisaCep);
            if ($('#id_pk').val() > 0) {
                carrega_estados_agencias();
                $('#btn_submit').prop('disabled', false);
                $('#btn_submit').removeClass('disabled');
            }

                              

        })

        $('#id_nome').attr('style', "text-transform: uppercase;")

        $('#id_nome').on("change", function () {
            nome = $('#id_nome').val();
            p = ["LTDA", "PROPAGANDA", "COMUNICAÇÃO", "CRIAÇÃO", "PROMOÇÕES", "DESIGN"]
            nome_final = ''
            nome_array = nome.split(' ')
            for (x in nome_array) {
               if (jQuery.inArray( nome_array[x].toUpperCase(), p )==-1) {
                    nome_final = nome_final + ' ' + nome_array[x]

                }
            }
            $('#id_nome').val(nome_final)
        })

        $('#id_descricao').attr("style", "width: 500px;");
        $( "#id_email, #id_VP_Email, #id_C1_Email, #id_C2_Email ").on("change", function () {
            valor = $(this).val();
            valEmail1= $('#id_email').val();
            valEmail2 = $('#id_VP_Email').val();
            valEmail3 = $('#id_C1_Email').val();
            valEmail4 = $('#id_C2_Email').val();

            if (valor != '') {
                if (valEmail1 == valEmail2 && valEmail1 != '' && valEmail2 != '') {
                    Swal.fire({
                        type: 'error',
                        text: 'Atenção! E-mails devem ser diferentes!',
                    }).then(function() {

                        $(this).focus();

                    });
                }
                if (valEmail1 == valEmail3 && valEmail1 != '' && valEmail3 != '') {
                    Swal.fire({
                        type: 'error',
                        text: 'Atenção! E-mails devem ser diferentes!',
                    }).then(function() {

                        $(this).focus();
                    });
                }
                if (valEmail1 == valEmail4 && valEmail1 != '' && valEmail4 != '') {
                    Swal.fire({
                        type: 'error',
                        text: 'Atenção! E-mails devem ser diferentes!',
                    }).then(function() {

                        $(this).focus();
                    });
                }
                if (valEmail2 == valEmail3 && valEmail2 != '' && valEmail3 != '') {
                    Swal.fire({
                        type: 'error',
                        text: 'Atenção! E-mails devem ser diferentes!',
                    }).then(function() {

                        $(this).focus();
                    });
                }
                if (valEmail2 == valEmail4 && valEmail2 != '' && valEmail4 != '') {
                    Swal.fire({
                        type: 'error',
                        text: 'Atenção! E-mails devem ser diferentes!',
                    }).then(function() {

                        $(this).focus();
                    });
                }
                if (valEmail3 == valEmail4 && valEmail3 != '' && valEmail4 != '') {
                    Swal.fire({
                        type: 'error',
                        text: 'Atenção! E-mails devem ser diferentes!',


                    }).then(function() {

                        $(this).focus();


                    });

                }

            }

        });
    </script>
</td>
</tr>
</table>
</body>
</html>