{% extends "base/base.html" %}
{% load staticfiles %}

{% block conteudo %}
    <div class="row my-2">
        <div class="col-md-12">

            <div class="card">
                <div class="card-body formulario-empresa">

                    {% include "base/includes/messages.html" with messages=messages %}

                    <form action="{% url 'nova-empresa' %}" method="post">
                        {% csrf_token %}

                        <div class="row my-1">
                            <div class="col-12 text-center font-weight-bold">
                                <img src="{% static "base/img/logo.png" %}" class="logo" alt="Logomarca Colunistas">
                                <h1 class="title">Digite os dados da empresa</h1>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                {{formulario_cadastro.nome.label_tag}}
                                {{formulario_cadastro.nome}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.nome.help_text}}</span>
                                {{formulario_cadastro.nome.errors}}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                {{formulario_cadastro.regional.label_tag}}
                                {{formulario_cadastro.regional}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.regional.help_text}}</span>
                                {{formulario_cadastro.regional.errors}}
                            </div>
                            <div class="col-md-6">
                                {{formulario_cadastro.area.label_tag}}
                                {{formulario_cadastro.area}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.area.help_text}}</span>
                                {{formulario_cadastro.area.errors}}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-2">
                                {{formulario_cadastro.cep.label_tag}}
                                {{formulario_cadastro.cep}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.cep.help_text}}</span>
                                {{formulario_cadastro.cep.errors}}
                            </div>
                            <div class="col-md-7">
                                {{formulario_cadastro.endereco.label_tag}}
                                {{formulario_cadastro.endereco}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.endereco.help_text}}</span>
                                {{formulario_cadastro.endereco.errors}}
                            </div>
                            <div class="col-md-3">
                                {{formulario_cadastro.bairro.label_tag}}
                                {{formulario_cadastro.bairro}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.bairro.help_text}}</span>
                                {{formulario_cadastro.bairro.errors}}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-1" style="width: 50px;">
                                {{formulario_cadastro.uf.label_tag}}
                                {{formulario_cadastro.uf}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.uf.help_text}}</span>
                                {{formulario_cadastro.uf.errors}}
                            </div>
                            <div class="col-md-4">
                                {{formulario_cadastro.municipio.label_tag}}
                                {{formulario_cadastro.municipio}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.municipio.help_text}}</span>
                                {{formulario_cadastro.municipio.errors}}
                            </div>
                            <div class="col-md-1">
                                {{formulario_cadastro.ddd.label_tag}}
                                {{formulario_cadastro.ddd}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.ddd.help_text}}</span>
                                {{formulario_cadastro.ddd.errors}}
                            </div>
                            <div class="col-md-3">
                                {{formulario_cadastro.telefone.label_tag}}
                                {{formulario_cadastro.telefone}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.telefone.help_text}}</span>
                                {{formulario_cadastro.telefone.errors}}
                            </div>
                            <div class="col-md-3">
                                {{formulario_cadastro.celular.label_tag}}
                                {{formulario_cadastro.celular}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.celular.help_text}}</span>
                                {{formulario_cadastro.celular.errors}}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                {{formulario_cadastro.homepage.label_tag}}
                                {{formulario_cadastro.homepage}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.homepage.help_text}}</span>
                                {{formulario_cadastro.homepage.errors}}
                            </div>
                            <div class="col-md-6">
                                {{formulario_cadastro.email.label_tag}}
                                {{formulario_cadastro.email}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.email.help_text}}</span>
                                {{formulario_cadastro.email.errors}}
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row my-3">
                            <div class="col-12 text-center font-weight-bold">VP ou Diretor responsável pelas inscrições</div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                {{formulario_cadastro.VP_Nome.label_tag}}
                                {{formulario_cadastro.VP_Nome}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.VP_Nome.help_text}}</span>
                                {{formulario_cadastro.VP_Nome.errors}}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                {{formulario_cadastro.VP_Cargo.label_tag}}
                                {{formulario_cadastro.VP_Cargo}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.VP_Cargo.help_text}}</span>
                                {{formulario_cadastro.VP_Cargo.errors}}
                            </div>
                            <div class="col-md-4">
                                {{formulario_cadastro.VP_Email.label_tag}}
                                {{formulario_cadastro.VP_Email}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.VP_Email.help_text}}</span>
                                {{formulario_cadastro.VP_Email.errors}}
                            </div>
                            <div class="col-md-1">
                                {{formulario_cadastro.VP_DDD.label_tag}}
                                {{formulario_cadastro.VP_DDD}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.VP_DDD.help_text}}</span>
                                {{formulario_cadastro.VP_DDD.errors}}
                            </div>
                            <div class="col-md-4">
                                {{formulario_cadastro.VP_Telefone.label_tag}}
                                {{formulario_cadastro.VP_Telefone}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.VP_Telefone.help_text}}</span>
                                {{formulario_cadastro.VP_Telefone.errors}}
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row my-3">
                            <div class="col-12 text-center font-weight-bold">Outros Contatos na Empresa (Nomes que também receberão as comunicações da Abracomp sobre a premiação.)</div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                {{formulario_cadastro.C1_Nome.label_tag}}
                                {{formulario_cadastro.C1_Nome}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.C1_Nome.help_text}}</span>
                                {{formulario_cadastro.C1_Nome.errors}}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                {{formulario_cadastro.C1_Cargo.label_tag}}
                                {{formulario_cadastro.C1_Cargo}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.C1_Cargo.help_text}}</span>
                                {{formulario_cadastro.C1_Cargo.errors}}
                            </div>
                            <div class="col-md-4">
                                {{formulario_cadastro.C1_Email.label_tag}}
                                {{formulario_cadastro.C1_Email}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.C1_Email.help_text}}</span>
                                {{formulario_cadastro.C1_Email.errors}}
                            </div>
                            <div class="col-md-1">
                                {{formulario_cadastro.C1_DDD.label_tag}}
                                {{formulario_cadastro.C1_DDD}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.C1_DDD.help_text}}</span>
                                {{formulario_cadastro.C1_DDD.errors}}
                            </div>
                            <div class="col-md-4">
                                {{formulario_cadastro.C1_Telefone.label_tag}}
                                {{formulario_cadastro.C1_Telefone}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.C1_Telefone.help_text}}</span>
                                {{formulario_cadastro.C1_Telefone.errors}}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                {{formulario_cadastro.C2_Nome.label_tag}}
                                {{formulario_cadastro.C2_Nome}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.C2_Nome.help_text}}</span>
                                {{formulario_cadastro.C2_Nome.errors}}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                {{formulario_cadastro.C2_Cargo.label_tag}}
                                {{formulario_cadastro.C2_Cargo}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.C2_Cargo.help_text}}</span>
                                {{formulario_cadastro.C2_Cargo.errors}}
                            </div>
                            <div class="col-md-4">
                                {{formulario_cadastro.C2_Email.label_tag}}
                                {{formulario_cadastro.C2_Email}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.C2_Email.help_text}}</span>
                                {{formulario_cadastro.C2_Email.errors}}
                            </div>
                            <div class="col-md-1">
                                {{formulario_cadastro.C2_DDD.label_tag}}
                                {{formulario_cadastro.C2_DDD}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.C2_DDD.help_text}}</span>
                                {{formulario_cadastro.C2_DDD.errors}}
                            </div>
                            <div class="col-md-4">
                                {{formulario_cadastro.C2_Telefone.label_tag}}
                                {{formulario_cadastro.C2_Telefone}}
                                <span class="text-muted" style="font-size: 12px;">{{formulario_cadastro.C2_Telefone.help_text}}</span>
                                {{formulario_cadastro.C2_Telefone.errors}}
                            </div>
                        </div>

                        <hr class="my-4">

                        <div id="formset_agencias">

                            {{formset_agencias.management_form}}

                            <div class="row header-agencia d-none">
                                <div class="col-md-11 text-center">
                                    <h1 class="title">Agências:</h1>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 text-center botoes-adicionais d-none">
                                <!-- <a href="javascript:dados_fiscais()" id="btn_dados_fiscais" class="btn btn-outline-primary">Dados Fiscais</a> -->
                                <a href="/admin/inscricao/inscricao/add/" id="btn_inscricoes" class="btn btn-outline-primary">Cadastrar Inscrições</a>
                            </div>
                            <div class="col-md-12 text-center botoes-inciais">
                                <button type="button" onclick="gravar_dados()" class="btn btn-primary" data-toggle="tooltip" data-placement="top" enable>Gravar dados</button>
                                <a href="javascript:adiciona_agencia()" class="btn btn-primary" data-toggle="tooltip" data-placement="top" title="Você pode adicionar mais de uma agência, clicando aqui">Adicionar Agência</a>
                            </div>
                        </div>

                    </form>
                </div>
            </div>

        </div>
    </div>
{% endblock %}

{% block js %}
    <script>
        // Variáveis globais:
        var estados_agencias = '';
        dados = {};

        function carrega_dados_formulario() {
            dados.csrfmiddlewaretoken = $('input[name="csrfmiddlewaretoken"]').val()
            dados.regional = $('#id_regional').val()
            dados.nome = $('#id_nome').val()
            dados.area = $('#id_area').val()
            dados.cep = $('#id_cep').val()
            dados.endereco = $('#id_endereco').val()
            dados.bairro = $('#id_bairro').val()
            dados.municipio = $('#id_municipio').val()
            dados.uf = $('#id_uf').val()
            dados.ddd = $('#id_ddd').val()
            dados.telefone = $('#id_telefone').val()
            dados.celular = $('#id_celular').val()
            dados.homepage = $('#id_homepage').val()
            dados.email = $('#id_email').val()
            dados.VP_Nome = $('#id_VP_Nome').val()
            dados.VP_Cargo = $('#id_VP_Cargo').val()
            dados.VP_Email = $('#id_VP_Email').val()
            dados.VP_DDD = $('#id_VP_DDD').val()
            dados.VP_Telefone = $('#id_VP_Telefone').val()
            dados.C1_Nome = $('#id_C1_Nome').val()
            dados.C1_Cargo = $('#id_C1_Cargo').val()
            dados.C1_Email = $('#id_C1_Email').val()
            dados.C1_DDD = $('#id_C1_DDD').val()
            dados.C1_Telefone = $('#id_C1_Telefone').val()
            dados.C2_Nome = $('#id_C2_Nome').val()
            dados.C2_Cargo = $('#id_C2_Cargo').val()
            dados.C2_Email = $('#id_C2_Email').val()
            dados.C2_DDD = $('#id_C2_DDD').val()
            dados.C2_Telefone = $('#id_C2_Telefone').val()

            dados['form-TOTAL_FORMS'] = $('#id_form-TOTAL_FORMS').val()
            dados['form-INITIAL_FORMS'] = $('#id_form-INITIAL_FORMS').val()
            dados['form-MIN_NUM_FORMS'] = $('#id_form-MIN_NUM_FORMS').val()
            dados['form-MAX_NUM_FORMS'] = $('#id_form-MAX_NUM_FORMS').val()

            for (i = 0; i < parseInt(dados['form-TOTAL_FORMS']); i++) {
                dados[`form-${i}-nome`] = $(`#id_form-${i}-nome`).val()
                dados[`form-${i}-uf`] = $(`#id_form-${i}-uf`).val()
            }
        }

        function carrega_estados_agencias() {
            var url = '/estados-regional/?regional=' + $('#id_regional').val()
            var area = $('#id_area option:selected' ).text();



            if (area.substring(0,9)  == 'Produtora' ) {
                url = '/estados-regional/?regional=-1'
            }


            $.get(url)
            .done(function(resposta) {
                estados_agencias = '';
                $.each(resposta.estados, function(i, estado) {
                    estados_agencias += `<option value="${estado}">${estado}</option>`
                });
                if ($('#id_form-TOTAL_FORMS').val() == 0) {
                    adiciona_agencia();
                    $('.header-agencia').removeClass('d-none');
                }else{
                    $( ".select-uf" ).each(function() {
                        var option = "<option value='' selected disabled>Selecione...</option>";
                        $(this).empty().append(option).append(estados_agencias);
                    });
                }

            })
        }

        function gravar_dados() {
            var url = '{% url 'nova-empresa' %}'
            carrega_dados_formulario()

            $.post(url, dados)
            .done(resposta => {
                if (resposta.status == 200) {
                    $('.botoes-adicionais').removeClass('d-none');
                    Swal.fire({
                        type: 'success',
                        text: 'Empresa cadastrada com sucesso',
                    })
                    $('.botoes-inciais').addClass('d-none');
                } else {
                    Swal.fire({
                        type: 'error',
                        text: `Erro: ${resposta.texto}`,
                    })
                    console.log(resposta)
                }
            })
            .fail(resposta => {
                Swal.fire({
                    type: 'error',
                    text: `Erro: ${resposta.statusText}`,
                })
                console.log(resposta)
            })
        }

        function adiciona_agencia() {
            var n_forms = $('#id_form-TOTAL_FORMS').val()
            $('#formset_agencias').append(`
                <div class="row my-2">
                    <div class="col-md-2">
                        <label for="id_form-${n_forms}-nome">Nome:</label>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="form-${n_forms}-nome" id="id_form-${n_forms}-nome" />
                    </div>
                    <div class="col-md-2">
                        <label for="id_form-${n_forms}-uf">Estado:</label>
                    </div>
                    <div class="col-md-4">
                        <select name="uf" id="id_form-${n_forms}-uf" class="form-control select-uf">
                            <option value="" selected disabled>Selecione...</option>
                            ${estados_agencias}
                        </select>
                    </div>
                </div>
            `)
            $('#id_form-TOTAL_FORMS').val( parseInt($('#id_form-TOTAL_FORMS').val()) + 1 )
        }

        function exclui_agencia() {}

        function verificar_nome_empresa() {
            if ($('#id_nome').val()) {
                var url = `/consulta-empresa/${$('#id_nome').val()}/`
                $.get(url)
                .done(function(resposta) {
                    if (resposta.existe) {
                        $('#btn_submit').prop('disabled', false)
                        $('#btn_submit').removeClass('disabled')

                        Swal.fire({
                            type: 'error',
                            title: 'AVISO',
                            text: 'Empresa já cadastrada',
                        })
                    } else {
                        $('#btn_submit').prop('disabled', false)
                        $('#btn_submit').removeClass('disabled')
                    }
                })
                .fail(function() {
                    console.log('Erro ao acessar o servidor')
                });
            }
        }

        function dados_fiscais() {
            Swal.fire({
                html: `{{formulario_fiscal.as_p}}`,
                showCancelButton: true,
                confirmButtonText: 'Gravar',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    dados = {
                        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val(),
                        cnpj: $('#id_cnpj').val(),
                        inscricao_estadual: $('#id_inscricao_estadual').val(),
                        inscricao_municipal: $('#id_inscricao_municipal').val(),
                    }

                    $.post('/cadastro-fiscal/', dados)
                    .done((resposta) => {
                        if (resposta.status == 200) {
                            Swal.fire({
                                type: 'success',
                                text: 'Dados cadastrados com sucesso.',
                            })
                        } else {
                            Swal.fire({
                                type: 'error',
                                text: resposta.texto,
                            })
                        }
                    })
                    .fail((resposta) => {
                        if (resposta) {
                            Swal.fire({
                                type: 'error',
                                text: `Erro: ${resposta.statusText}`,
                            })
                        } else {
                            Swal.fire({
                                type: 'error',
                                text: 'Erro ao conectar com o servidor.',
                            })
                        }
                    })
                },
                allowOutsideClick: () => !Swal.isLoading()
            })
        }

        function pesquisaCep() {
            var entrada = document.getElementById('id_cep').value.replace('-', '')
            $.get(`https://viacep.com.br/ws/${entrada}/json/`, function(endereco, status) {
                if (status == 'success') {
                    //console.log(endereco)
                    $('#id_endereco').val(endereco.logradouro)
                    $('#id_bairro').val(endereco.bairro)
                    $('#id_uf').val(endereco.uf)
                    $('#id_municipio').val(endereco.localidade)
                }
            });
        }

        $(document).ready(function(){
            $("body").tooltip({ selector: '[data-toggle=tooltip]' });
            $('input[type="text"], input[type="email"], input[type="url"], select').addClass('form-control');

            $('#id_regional').change(carrega_estados_agencias);
            $('#id_area').change(carrega_estados_agencias);
            $('#id_nome').blur(verificar_nome_empresa);
            $('#id_cep').blur(pesquisaCep);

        })

        $('#id_nome').attr('style', "text-transform: uppercase;")

        $('#id_nome').on("change", function () {
            nome = $('#id_nome').val();
            p = ["LTDA", "PROPAGANDA", "COMUNICAÇÃO", "CRIAÇÃO", "PROMOÇÕES", "DESIGN"]
            nome_final = ''
            nome_array = nome.split(' ')
            for (x in nome_array) {
               if (jQuery.inArray( nome_array[x].toUpperCase(), p )==-1) {
                    nome_final = nome_final + ' ' + nome_array[x]

                }
            }
            $('#id_nome').val(nome_final)
        })

        $('#id_descricao').attr("style", "width: 500px;");
        $( "#id_email, #id_VP_Email, #id_C1_Email, #id_C2_Email ").on("change", function () {
            valor = $(this).val();
            valEmail1= $('#id_email').val();
            valEmail2 = $('#id_VP_Email').val();
            valEmail3 = $('#id_C1_Email').val();
            valEmail4 = $('#id_C2_Email').val();

            if (valor != '') {
                if (valEmail1 == valEmail2 && valEmail1 != '' && valEmail2 != '') {
                    Swal.fire({
                        type: 'error',
                        text: 'Atenção! E-mails devem ser diferentes!',
                    }).then(function() {

                        $(this).focus();

                    });
                }
                if (valEmail1 == valEmail3 && valEmail1 != '' && valEmail3 != '') {
                    Swal.fire({
                        type: 'error',
                        text: 'Atenção! E-mails devem ser diferentes!',
                    }).then(function() {

                        $(this).focus();
                    });
                }
                if (valEmail1 == valEmail4 && valEmail1 != '' && valEmail4 != '') {
                    Swal.fire({
                        type: 'error',
                        text: 'Atenção! E-mails devem ser diferentes!',
                    }).then(function() {

                        $(this).focus();
                    });
                }
                if (valEmail2 == valEmail3 && valEmail2 != '' && valEmail3 != '') {
                    Swal.fire({
                        type: 'error',
                        text: 'Atenção! E-mails devem ser diferentes!',
                    }).then(function() {

                        $(this).focus();
                    });
                }
                if (valEmail2 == valEmail4 && valEmail2 != '' && valEmail4 != '') {
                    Swal.fire({
                        type: 'error',
                        text: 'Atenção! E-mails devem ser diferentes!',
                    }).then(function() {

                        $(this).focus();
                    });
                }
                if (valEmail3 == valEmail4 && valEmail3 != '' && valEmail4 != '') {
                    Swal.fire({
                        type: 'error',
                        text: 'Atenção! E-mails devem ser diferentes!',


                    }).then(function() {

                        $(this).focus();


                    });

                }

            }

        });
    </script>
{% endblock %}
